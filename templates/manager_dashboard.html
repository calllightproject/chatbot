<!DOCTYPE html>
<html lang="{{ session.get('language', 'en') }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manager Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --core-blue: #00205b;
      --accent-blue: #007eb4;
      --neutral-gray-text: #303235;
      --light-gray-background: #f5f5f5;
      --white: #ffffff;
    }
    body { font-family: 'Inter', sans-serif; background-color: var(--light-gray-background); color: var(--neutral-gray-text); }
    .header-title { color: var(--core-blue); }
    .card { background-color: var(--white); }
    .button-primary { background-color: var(--core-blue); color: var(--white); }
    .button-primary:hover { background-color: #093582; }
    .link { color: var(--accent-blue); }
    .link:hover { color: var(--core-blue); }
    .badge { font-size: 0.75rem; line-height: 1rem; }
    .pin-input { letter-spacing: 0.2em; }
  </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
  <div class="container mx-auto max-w-7xl">
    <header class="mb-8">
      <h1 class="text-3xl font-bold header-title">Manager Dashboard</h1>
      <p class="text-md mt-1">Manage staff, PINs, and view system activity.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left: Manage Staff -->
      <div class="lg:col-span-1 card p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-semibold mb-4">Manage Staff</h2>

        <!-- Add Staff -->
        <form action="{{ url_for('manager_dashboard') }}" method="POST" class="mb-6">
          <input type="hidden" name="action" value="add_staff" />
          <h3 class="text-lg font-medium text-gray-600 mb-2">Add New Staff Member</h3>

          <div class="space-y-4">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
              <input type="text" name="name" id="name" required
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
            </div>

            <div>
              <label for="role" class="block text-sm font-medium text-gray-700">Role</label>
              <select name="role" id="role"
                      class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="nurse">Nurse</option>
                <option value="cna">CNA</option>
              </select>
            </div>

            <div>
              <label for="preferred_shift" class="block text-sm font-medium text-gray-700">Preferred shift</label>
              <select name="preferred_shift" id="preferred_shift"
                      class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="">Unspecified</option>
                <option value="day">Day</option>
                <option value="night">Night</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">
                Used to group/filter nurses on the Staff Assignments page.
              </p>
            </div>

            <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium button-primary transition-colors">
              Add Staff
            </button>
          </div>
        </form>

        <!-- Current Staff -->
        <div>
          <h3 class="text-lg font-medium text-gray-600 mb-2">Current Staff</h3>
          <ul class="space-y-3">
            {% for member in staff %}
            <li class="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <div class="flex flex-col gap-3">
                <div class="flex items-start justify-between gap-4">
                  <div>
                    <p class="font-semibold text-gray-900">{{ member.name }}</p>
                    <div class="flex items-center gap-2 mt-1">
                      <span class="badge inline-block px-2 py-0.5 rounded bg-blue-100 text-blue-800">
                        {{ member.role|lower == 'nurse' and 'Nurse' or 'CNA' }}
                      </span>
                      {% if member.preferred_shift %}
                        <span class="badge inline-block px-2 py-0.5 rounded bg-amber-100 text-amber-800">
                          {{ member.preferred_shift|capitalize }}
                        </span>
                      {% else %}
                        <span class="badge inline-block px-2 py-0.5 rounded bg-gray-100 text-gray-700">
                          Unspecified
                        </span>
                      {% endif %}
                    </div>
                  </div>

                  <form action="{{ url_for('manager_dashboard') }}" method="POST">
                    <input type="hidden" name="action" value="remove_staff" />
                    <input type="hidden" name="staff_id" value="{{ member.id }}" />
                    <button type="submit" class="text-red-600 hover:text-red-700 text-sm font-medium">Remove</button>
                  </form>
                </div>

                <!-- PIN controls -->
                <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4">
                  <form action="{{ url_for('manager_dashboard') }}" method="POST" class="flex items-center gap-2">
                    <input type="hidden" name="action" value="set_pin" />
                    <input type="hidden" name="staff_id" value="{{ member.id }}" />
                    <label class="text-sm text-gray-700">PIN:</label>
                    <input
                      type="password"
                      name="new_pin"
                      inputmode="numeric"
                      pattern="[0-9]{4,8}"
                      placeholder="4–8 digits"
                      title="Enter 4–8 digits"
                      required
                      class="pin-input w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    />
                    <button type="submit"
                      class="px-3 py-2 rounded-md text-sm font-medium text-white"
                      style="background-color:#0b6aa2">
                      Set PIN
                    </button>
                  </form>

                  <form action="{{ url_for('manager_dashboard') }}" method="POST">
                    <input type="hidden" name="action" value="clear_pin" />
                    <input type="hidden" name="staff_id" value="{{ member.id }}" />
                    <button type="submit"
                      class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300">
                      Clear PIN
                    </button>
                  </form>

                  {% if member.pin_set_at %}
                    <span class="text-xs text-gray-500">
                      Set {{ member.pin_set_at.strftime('%Y-%m-%d %H:%M') }} UTC
                    </span>
                  {% endif %}
                </div>
              </div>
            </li>
            {% else %}
            <li class="text-gray-500">No staff members found.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Right: Audit Log -->
      <div class="lg:col-span-2 card p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-semibold mb-4">Recent Activity (Audit Log)</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
              </tr>
            </thead>
            <tbody id="audit-log-body" class="bg-white divide-y divide-gray-200">
              {% for log in audit_log %}
              <tr>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} UTC
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ log.event_type }}</td>
                <td class="px-4 py-4 text-sm text-gray-500">{{ log.details }}</td>
              </tr>
              {% else %}
              <tr id="no-logs-row">
                <td colspan="3" class="px-4 py-4 text-center text-gray-500">No audit log entries found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <footer class="text-center mt-12">
      <a href="{{ url_for('dashboard') }}" class="link transition-colors">← Back to Main Dashboard</a>
    </footer>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io();
    socket.on('new_audit_log', function(data) {
      const tableBody = document.getElementById('audit-log-body');
      const noLogsRow = document.getElementById('no-logs-row');
      if (noLogsRow) noLogsRow.remove();

      const tr = document.createElement('tr');

      const tdTime = document.createElement('td');
      tdTime.className = 'px-4 py-4 whitespace-nowrap text-sm text-gray-500';
      tdTime.textContent = data.timestamp;

      const tdEvent = document.createElement('td');
      tdEvent.className = 'px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
      tdEvent.textContent = data.event_type;

      const tdDetails = document.createElement('td');
      tdDetails.className = 'px-4 py-4 text-sm text-gray-500';
      tdDetails.textContent = data.details;

      tr.appendChild(tdTime);
      tr.appendChild(tdEvent);
      tr.appendChild(tdDetails);
      tableBody.prepend(tr);
    });
  </script>
</body>
</html>
