<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>
    {% if nurse_context|default(false) %}
      My Rooms — {{ nurse_name|default('') }}
    {% else %}
      Real-Time Request Dashboard
    {% endif %}
  </title>
  <style>
    :root {
      --core-blue: #00205b;
      --accent-blue: #007eb4;
      --neutral-gray-text: #303235;
      --light-gray-background: #f5f5f5;
      --white: #ffffff;
      --border:#e5e7eb;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding: 20px;
      background-color: var(--light-gray-background);
      color: var(--neutral-gray-text);
    }
    .dashboard-container {
      max-width: 980px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      border:1px solid var(--border);
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }
    .header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: start;
      margin-bottom: 12px;
    }
    h1 {
      color: var(--core-blue);
      margin: 0 0 6px 0;
      font-size: 1.5rem;
    }
    .subline { margin: 0 0 8px 0; font-size: 0.95rem; color: #555; }
    .chip-row { display:flex; flex-wrap:wrap; gap:6px; margin: 6px 0 0 0; }
    .chip { padding:6px 10px; border-radius:9999px; background:#eef2f7; border:1px solid #d7dde6; font-size:.85rem; color:#334155; }

    .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-self:end; }
    .link-btn, .btn {
      display:inline-block; padding:8px 12px; border-radius:8px; text-decoration:none;
      border:1px solid var(--core-blue); background: var(--core-blue); color:#fff; font-size:.9rem;
      transition: background-color .2s ease; white-space:nowrap; cursor:pointer;
    }
    .link-btn:hover, .btn:hover { background:#093582; }
    .seg {
      display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff;
    }
    .seg a {
      padding:8px 10px; text-decoration:none; color:#0f172a; background:#fff;
      border-right:1px solid var(--border); font-size:.9rem;
    }
    .seg a:last-child { border-right:none; }
    .seg a.active { background:#e6eef8; color:#0b2a6f; font-weight:600; }

    #requests-list { list-style:none; padding:0; margin:16px 0 0 0; }
    .request-item {
      display:flex; align-items:center; border:1px solid #ddd; padding:15px; margin-bottom:10px;
      border-radius:8px; background-color:#fff; gap:15px; transition: background-color .5s ease, opacity .5s ease;
    }
    .request-item.cna   { border-left: 6px solid var(--accent-blue); }
    .request-item.nurse { border-left: 6px solid #d43f27; }

    .request-item p { margin:0; font-size:1.05rem; flex-grow:1; }
    .meta { display:flex; gap:10px; align-items:center; white-space:nowrap; font-size:.9rem; color:#555; flex-wrap:wrap; }
    .role-span { font-size:.9rem; color:#555; }
    .timestamp { font-size:.9rem; color:#555; }

    .request-item button {
      padding:8px 12px; border:none; color:white; border-radius:6px; cursor:pointer; font-size:14px; transition:opacity .25s;
    }
    .ack-button    { background-color: #ffc107; color:#000; }
    .omw-button    { background-color: #28a745; }
    .asap-button   { background-color: #6f42c1; }
    .defer-btn     { background-color: #17a2b8; }
    .complete-btn  { background-color: #6c757d; }
    .request-item button:disabled { opacity:.5; cursor:not-allowed; }

    .status-new    { background-color: #eefcf1; }
    .status-warn   { background-color: #fff5dd; }
    .status-urgent { background-color: #fde8e8; }

    .toolbar { display:flex; align-items:center; gap:10px; margin-top:8px; }
    .muted { font-size:.85rem; color:#64748b; }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <div class="header">
      <div>
        <h1>
          {% if nurse_context|default(false) %}
            My Rooms — {{ nurse_name|default('') }}
          {% else %}
            Real-Time Request Dashboard
          {% endif %}
        </h1>

        {% if nurse_context|default(false) %}
          {% set my_rooms = nurse_rooms|default([]) %}
          {% if my_rooms and my_rooms|length > 0 %}
            <div class="subline">Assigned rooms today:</div>
            <div class="chip-row">
              {% for r in my_rooms %}
                <span class="chip">{{ r }}</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="subline">No rooms assigned yet for today.</div>
          {% endif %}
        {% endif %}

        <div class="toolbar">
          {% if nurse_context|default(false) %}
            <div class="seg" aria-label="Shift">
              <a href="{{ day_url }}"   class="{% if shift=='day' %}active{% endif %}">Day</a>
              <a href="{{ night_url }}" class="{% if shift=='night' %}active{% endif %}">Night</a>
            </div>
            <div class="seg" aria-label="Scope">
              <a href="{{ url_for('staff_dashboard_for_nurse', staff_name=nurse_name, shift=shift, scope='mine') }}" class="{% if scope=='mine' %}active{% endif %}">My Rooms</a>
              <a href="{{ url_for('staff_dashboard_for_nurse', staff_name=nurse_name, shift=shift, scope='all')  }}" class="{% if scope=='all'  %}active{% endif %}">All</a>
            </div>
          {% endif %}
          <button id="manual-refresh" class="btn" type="button">Refresh</button>
          <span class="muted" id="last-refresh"></span>
        </div>
      </div>

      <div class="actions">
        {% if nurse_context|default(false) %}
          <a class="link-btn" href="{{ url_for('dashboard') }}">Manager View</a>
        {% else %}
          <a class="link-btn" href="{{ url_for('staff_portal') }}">View My Rooms</a>
          <a class="link-btn" href="{{ url_for('analytics') }}">View Analytics</a>
        {% endif %}
      </div>
    </div>

    <ul id="requests-list">
      {% for request in active_requests|default([]) %}
        <li class="request-item {{ request.role|default('') }}"
            id="{{ request.id|default('') }}"
            data-id="{{ request.id|default('') }}"
            data-room="{{ request.room|default('') }}"
            data-request="{{ request.request|default('') }}"
            data-role="{{ request.role|default('') }}"
            data-timestamp="{{ request.timestamp|default('') }}">
          <p>{{ request.request|default('') }}</p>
          <div class="meta">
            <span>Room: {{ request.room|default('—') }}</span>
            <span class="role-span">For: {{ request.role|default('')|upper }}</span>
            <span class="timestamp"></span>
          </div>
          <button class="ack-button">Acknowledge</button>
          <button class="omw-button">On my way</button>
          <button class="asap-button">Be there ASAP</button>
          {% if request.role|default('') == 'cna' %}
            <button class="defer-btn">Defer to Nurse</button>
          {% endif %}
          <button class="complete-btn">Complete</button>
        </li>
      {% else %}
        <li class="request-item" style="justify-content:center">
          <p>No active requests.</p>
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Context for JS -->
  <script>
    const NurseContext = {{ nurse_context|default(false)|tojson }};
    const NurseName    = {{ nurse_name|default('')|tojson }};
    const NurseShift   = {{ shift|default('day')|tojson }};
    const NurseScope   = {{ scope|default('all')|tojson }};
  </script>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script type="text/javascript">
    var socket = io();

    // --- Local holding of status so polling doesn't wipe the buttons ---
    const LocalStatus = new Map(); // request_id -> 'ack' | 'omw' | 'asap'

    let audioContext;
    function playNotificationSound() {
      try {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') audioContext.resume();
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain); gain.connect(audioContext.destination);
        osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioContext.currentTime);
        gain.gain.setValueAtTime(0, audioContext.currentTime);
        gain.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
        gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
        osc.start(audioContext.currentTime);
        osc.stop(audioContext.currentTime + 0.5);
      } catch (_) {}
    }

    function statusBadgeHTML(st) {
      if (!st) return '';
      const label = st === 'ack' ? 'Acknowledged' : (st === 'omw' ? 'On my way' : 'ASAP');
      return `<span class="chip" style="background:#fff3cd;border-color:#ffe69c;">${label}</span>`;
    }

    function updateAllTimersAndColors() {
      const items = document.querySelectorAll('#requests-list .request-item');
      const now = new Date();

      items.forEach(item => {
        const raw = item.dataset.timestamp || '';
        const ts = raw ? new Date(raw) : null;
        const minutes = ts ? Math.floor((now - ts) / 60000) : 0;

        const tsEl = item.querySelector('.timestamp');
        if (tsEl) tsEl.textContent = ts ? (minutes > 0 ? `${minutes}m ago` : 'Just now') : '';

        item.classList.remove('status-new', 'status-warn', 'status-urgent');
        if (ts) {
          if (minutes >= 10) item.classList.add('status-urgent');
          else if (minutes >= 5) item.classList.add('status-warn');
          else item.classList.add('status-new');
        }
      });
    }

    function buildRequestHTML(data) {
      const isCNA = (data.role || '') === 'cna';
      const deferBtn = isCNA ? '<button class="defer-btn">Defer to Nurse</button>' : '';
      const st = LocalStatus.get(data.id); // prefer locally remembered status

      return `
        <p>${(data.request || '')}</p>
        <div class="meta">
          <span>Room: ${(data.room || '—')}</span>
          <span class="role-span">For: ${(data.role || '').toUpperCase()}</span>
          <span class="timestamp"></span>
          ${statusBadgeHTML(st)}
        </div>
        <button class="ack-button">Acknowledge</button>
        <button class="omw-button">On my way</button>
        <button class="asap-button">Be there ASAP</button>
        ${deferBtn}
        <button class="complete-btn">Complete</button>
      `;
    }

    function applyLocalStatusToItem(li) {
      const id = li?.dataset?.id;
      if (!id) return;
      const st = LocalStatus.get(id);
      if (!st) return;

      const ack = li.querySelector('.ack-button');
      const omw = li.querySelector('.omw-button');
      const asap = li.querySelector('.asap-button');

      if (st === 'ack') {
        if (ack) ack.disabled = true;
      } else if (st === 'omw') {
        if (ack) ack.disabled = true;
        if (omw) omw.disabled = true;
      } else if (st === 'asap') {
        if (ack) ack.disabled = true;
        if (asap) asap.disabled = true;
      }
    }

    function upsertRequestItem(req) {
      const list = document.getElementById('requests-list');
      if (!list || !req || !req.id) return;

      let li = document.getElementById(req.id);
      if (li) {
        // Update in place (do not remove)
        li.dataset.room = req.room || '';
        li.dataset.request = req.request || '';
        li.dataset.role = req.role || '';
        li.dataset.timestamp = req.timestamp || '';
        li.className = 'request-item ' + (req.role || '');
        li.innerHTML = buildRequestHTML(req);
      } else {
        // Create new
        li = document.createElement('li');
        li.id = req.id;
        li.className = 'request-item ' + (req.role || '');
        li.dataset.id = req.id || '';
        li.dataset.room = req.room || '';
        li.dataset.request = req.request || '';
        li.dataset.role = req.role || '';
        li.dataset.timestamp = req.timestamp || '';
        li.innerHTML = buildRequestHTML(req);
        document.getElementById('requests-list').prepend(li);
      }

      applyLocalStatusToItem(li);     // reapply local state after any render
    }

    function addRequestToDashboard(data) {
      upsertRequestItem(data);
      updateAllTimersAndColors();
    }

    // --- Socket events ---
    socket.on('new_request', function(data) {
      addRequestToDashboard(data);
      playNotificationSound();
    });

    socket.on('request_updated', function(data) {
      const item = document.getElementById(data.id || '');
      if (item) {
        item.classList.remove('cna');
        item.classList.add('nurse');
        const roleSpan = item.querySelector('.role-span');
        if (roleSpan) roleSpan.textContent = 'For: NURSE';
        const deferBtn = item.querySelector('.defer-btn');
        if (deferBtn) deferBtn.remove();
        updateAllTimersAndColors(); // keep original timestamp
      }
    });

    // remove by id OR by (room, request) for legacy N/A items
    socket.on('remove_request', function(data) {
      let el = null;
      if (data.id) el = document.getElementById(data.id);
      if (!el && (data.request || data.room)) {
        const items = document.querySelectorAll('#requests-list .request-item');
        el = Array.from(items).find(li => {
          const sameText = data.request ? (li.dataset.request || '') === data.request : true;
          const sameRoom = data.room ? (li.dataset.room || '') === data.room : true;
          return sameText && sameRoom;
        });
      }
      if (el) {
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 500);
      }
    });

    // --- Click handlers (remember local status) ---
    document.addEventListener('DOMContentLoaded', function() {
      const list = document.getElementById('requests-list');
      if (!list) return;

      list.addEventListener('click', function(e) {
        const btn = e.target;
        if (btn.tagName !== 'BUTTON') return;

        const item = btn.closest('.request-item');
        if (!item) return;

        const requestId   = item.dataset.id || '';
        const roomNumber  = item.dataset.room || '';
        const dashRoom    = item.dataset.room || '';
        const nurseName   = NurseName || '';

        function sendAck(status, dashMessage) {
          socket.emit('acknowledge_request', {
            request_id: requestId,
            room_number: roomNumber,
            nurse_name: nurseName,
            status: status,      // "ack" | "omw" | "asap"
            room: dashRoom,
            message: dashMessage
          });
        }

        if (btn.classList.contains('ack-button')) {
          btn.disabled = true;
          LocalStatus.set(requestId, 'ack');
          sendAck('ack', "✅ Request acknowledged.");
        } else if (btn.classList.contains('omw-button')) {
          btn.disabled = true;
          const ack = item.querySelector('.ack-button'); if (ack) ack.disabled = true;
          LocalStatus.set(requestId, 'omw');
          sendAck('omw', "✅ On my way.");
        } else if (btn.classList.contains('asap-button')) {
          btn.disabled = true;
          const ack = item.querySelector('.ack-button'); if (ack) ack.disabled = true;
          const omw = item.querySelector('.omw-button'); if (omw) omw.disabled = true;
          LocalStatus.set(requestId, 'asap');
          sendAck('asap', "In another room — will be there ASAP.");
        } else if (btn.classList.contains('defer-btn')) {
          socket.emit('defer_request', { id: requestId });
        } else if (btn.classList.contains('complete-btn')) {
          socket.emit('complete_request', {
            request_id: requestId,
            room_number: roomNumber,
            nurse_name: nurseName,
            request_text: item.dataset.request || ""
          });
          btn.disabled = true;
        }

        // update badge/disabled state immediately
        applyLocalStatusToItem(item);
      });

      // Manual refresh
      const btnRefresh = document.getElementById('manual-refresh');
      if (btnRefresh) btnRefresh.addEventListener('click', pollActiveRequests);

      // Start timers + polling
      updateAllTimersAndColors();
      setInterval(updateAllTimersAndColors, 60000);
      setTimeout(pollActiveRequests, 500);
      setInterval(pollActiveRequests, 20000);
    });

    function pollActiveRequests() {
      const params = new URLSearchParams();
      if (NurseContext && NurseName) {
        params.set('staff_name', NurseName);
        if (NurseShift) params.set('shift', NurseShift);
        params.set('scope', NurseScope || 'mine');
      } else {
        params.set('scope', 'all');
      }

      fetch(`/api/active_requests?${params.toString()}`)
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(json => {
          const list = json && json.active_requests ? json.active_requests : [];
          list.forEach(upsertRequestItem);
          updateAllTimersAndColors();
          const ts = new Date();
          const el = document.getElementById('last-refresh');
          if (el) el.textContent = `Updated ${ts.toLocaleTimeString()}`;
        })
        .catch(() => {
          const el = document.getElementById('last-refresh');
          if (el) el.textContent = `Update failed`;
        });
    }
  </script>
</body>
</html>
