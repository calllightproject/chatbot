<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Light Dashboard</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #4a4a4a; }
        #requests-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .request-card { background-color: white; border-left: 5px solid #007bff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 15px; width: 80%; max-width: 600px; transition: opacity 0.5s; }
        .request-card.nurse { border-left-color: #dc3545; }
        .request-card.cna { border-left-color: #28a745; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .room-number { font-size: 1.5em; font-weight: bold; }
        .timestamp { font-size: 0.9em; color: #6c757d; }
        .request-body { font-size: 1.1em; margin-bottom: 15px; }
        .complete-btn { background-color: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; float: right; }
        .complete-btn:hover { background-color: #218838; }
    </style>
</head>
<body>

    <h1>Active Requests</h1>
    <div id="requests-container">
        {% for request in active_requests %}
            <div class="request-card {{ request.role }}" id="{{ request.id }}">
                <div class="card-header">
                    <span class="room-number">Room: {{ request.room }}</span>
                    <span class="timestamp" data-timestamp="{{ request.timestamp }}"></span>
                </div>
                <p class="request-body">{{ request.request }}</p>
                <button class="complete-btn" data-id="{{ request.id }}">Complete</button>
            </div>
        {% endfor %}
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // Establish connection to the server
        const socket = io();

        // Function to calculate and display "time ago"
        function updateTimestamps() {
            document.querySelectorAll('.timestamp').forEach(span => {
                const timestamp = new Date(span.dataset.timestamp);
                const now = new Date();
                const seconds = Math.floor((now - timestamp) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) {
                    span.textContent = Math.floor(interval) + " years ago";
                    return;
                }
                interval = seconds / 2592000;
                if (interval > 1) {
                    span.textContent = Math.floor(interval) + " months ago";
                    return;
                }
                interval = seconds / 86400;
                if (interval > 1) {
                    span.textContent = Math.floor(interval) + " days ago";
                    return;
                }
                interval = seconds / 3600;
                if (interval > 1) {
                    span.textContent = Math.floor(interval) + " hours ago";
                    return;
                }
                interval = seconds / 60;
                if (interval > 1) {
                    span.textContent = Math.floor(interval) + " minutes ago";
                    return;
                }
                span.textContent = Math.floor(seconds) + " seconds ago";
            });
        }
        
        // --- Event Listener for new requests ---
        socket.on('new_request', function(data) {
            const container = document.getElementById('requests-container');
            const card = document.createElement('div');
            card.className = `request-card ${data.role}`;
            // Also apply the unique ID to new requests that arrive in real-time
            card.id = data.id; 
            
            card.innerHTML = `
                <div class="card-header">
                    <span class="room-number">Room: ${data.room}</span>
                    <span class="timestamp" data-timestamp="${data.timestamp}">Just now</span>
                </div>
                <p class="request-body">${data.request}</p>
                <button class="complete-btn" data-id="${data.id}">Complete</button>
            `;
            container.prepend(card);
            // Re-attach event listener to the new button
            addClickListener(card.querySelector('.complete-btn'));
        });

        /*
          CHANGE #2: Added this new event listener.
          It listens for the 'remove_request' event sent by the server.
        */
        socket.on('remove_request', function(data) {
            const requestId = data.id;
            console.log(`Received command to remove request: ${requestId}`); // For debugging
            
            const requestElement = document.getElementById(requestId);
            if (requestElement) {
                // Fade out and then remove the element for a smooth effect
                requestElement.style.opacity = '0';
                setTimeout(() => requestElement.remove(), 500);
            }
        });
        
        // Function to add a click listener to a button
        function addClickListener(button) {
             button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-id');
                // When a "complete" button is clicked, tell the server.
                socket.emit('complete_request', { 'request_id': requestId });
            });
        }

        // --- Initial Setup ---
        // Add listeners to all buttons that were loaded with the page
        document.querySelectorAll('.complete-btn').forEach(button => {
            addClickListener(button);
        });

        // Update timestamps on page load and then every 30 seconds
        updateTimestamps();
        setInterval(updateTimestamps, 30000);
    </script>

</body>
</html>
