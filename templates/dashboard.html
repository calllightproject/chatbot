<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real-Time Request Dashboard</title>
  <style>
    :root{
      --navy:#00205b;
      --ink:#111827;
      --ink-60:#6b7280;
      --bg:#f7f8fb;
      --card:#ffffff;
      --border:#e5e7eb;

      --btn:#0a2f66;
      --btn-hover:#103a81;

      --ack:#fde68a;      /* yellow */
      --omw:#bbf7d0;      /* green */
      --asap:#c4b5fd;     /* purple */
      --defer:#7dd3fc;    /* cyan */
      --complete:#cbd5e1; /* gray */

      --left-nurse:#ef4444; /* red */
      --left-cna:#f59e0b;   /* amber */
    }

    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }

    /* Top bar */
    .shell{padding:24px}
    .top{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      justify-content:space-between;margin-bottom:16px
    }
    .title{font-weight:800;font-size:28px;color:var(--navy)}
    .right{display:flex;align-items:center;gap:12px}
    .btn{
      background:var(--navy);color:#fff;border:1px solid var(--navy);
      padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer
    }
    .btn:hover{background:#082b74}
    .updated{font-size:12px;color:var(--ink-60)}

    /* Cards */
    .list{display:flex;flex-direction:column;gap:16px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:12px;
      padding:18px 16px;position:relative;box-shadow:0 1px 3px rgba(0,0,0,.04)
    }
    .card::before{
      content:"";position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:12px 0 0 12px;
      background:var(--left-nurse)
    }
    .card.role-cna::before{background:var(--left-cna)}
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap
    }
    .req{font-size:18px;font-weight:700}
    .meta{font-size:14px;color:var(--ink-60)}
    .actions{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
    .pill{
      border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;color:#111827
    }
    .pill-ack{background:var(--ack)}
    .pill-omw{background:var(--omw)}
    .pill-asap{background:var(--asap)}
    .pill-defer{background:var(--defer)}
    .pill-complete{background:var(--complete)}
    .empty{color:var(--ink-60);font-size:14px;margin-top:12px}

    /* “My rooms / Analytics” buttons (top-right) */
    .link{background:var(--navy);color:#fff;text-decoration:none;padding:10px 16px;border-radius:10px;font-weight:700;border:1px solid var(--navy)}
    .link:hover{background:#082b74}
  </style>
</head>
<body>
<div class="shell">
  <div class="top">
    <div class="title">Real-Time Request Dashboard</div>
    <div class="right">
      <button id="refreshBtn" class="btn">Refresh</button>
      <span id="updated" class="updated">Updated {{ (active_requests|length > 0) and (active_requests[0].timestamp or '') }}</span>
      <a class="link" href="/staff-portal">View My Rooms</a>
      <a class="link" href="/analytics">View Analytics</a>
    </div>
  </div>

  <div id="list" class="list">
    {% if active_requests and active_requests|length > 0 %}
      {% for r in active_requests %}
        <div class="card role-{{ (r.role or 'nurse')|lower }}"
             id="req-{{ r.id }}"
             data-id="{{ r.id }}"
             data-room="{{ r.room or '' }}"
             data-role="{{ (r.role or '')|lower }}"
             data-ts="{{ r.timestamp or '' }}">
          <div class="row">
            <div class="req">{{ r.request }}</div>
            <div class="meta">
              Room: {{ r.room or '—' }} &nbsp;&nbsp; For: {{ (r.role or '')|upper }} &nbsp;&nbsp;
              <span class="ago"></span>
            </div>
          </div>
          <div class="actions">
            <button class="pill pill-ack" data-action="ack">Acknowledge</button>
            <button class="pill pill-omw" data-action="omw">On my way</button>
            <button class="pill pill-asap" data-action="asap">Be there ASAP</button>
            {% if (r.role or '')|lower == 'cna' %}
              <button class="pill pill-defer" data-action="defer">Defer to Nurse</button>
            {% endif %}
            <button class="pill pill-complete" data-action="complete">Complete</button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty">No active requests.</div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  // --- Helpers ---------------------------------------------------------------
  const listEl = document.getElementById('list');
  const updatedEl = document.getElementById('updated');
  const refreshBtn = document.getElementById('refreshBtn');
  refreshBtn.onclick = () => location.reload();

  function timeAgo(ts){
    if(!ts) return "";
    const t = new Date(ts);
    const s = Math.max(1, Math.floor((Date.now()-t.getTime())/1000));
    if(s<60) return "Just now";
    const m = Math.floor(s/60);
    if(m<60) return m+"m ago";
    const h = Math.floor(m/60);
    return h+"h ago";
  }
  function refreshAllAgo(){
    document.querySelectorAll('.card').forEach(card=>{
      const ts = card.dataset.ts;
      const span = card.querySelector('.ago');
      if(span) span.textContent = timeAgo(ts);
    });
  }
  setInterval(refreshAllAgo, 15000); // every 15s
  refreshAllAgo();

  function cardHTML(data){
    const role = (data.role||'nurse').toLowerCase();
    const deferBtn = role==='cna'
      ? `<button class="pill pill-defer" data-action="defer">Defer to Nurse</button>`
      : ``;
    return `
      <div class="card role-${role}" id="req-${data.id}"
           data-id="${data.id}" data-room="${data.room||''}"
           data-role="${role}" data-ts="${data.timestamp||''}">
        <div class="row">
          <div class="req">${escapeHtml(data.request||'')}</div>
          <div class="meta">
            Room: ${data.room || '—'} &nbsp;&nbsp; For: ${(data.role||'').toUpperCase()} &nbsp;&nbsp;
            <span class="ago">${timeAgo(data.timestamp||'')}</span>
          </div>
        </div>
        <div class="actions">
          <button class="pill pill-ack" data-action="ack">Acknowledge</button>
          <button class="pill pill-omw" data-action="omw">On my way</button>
          <button class="pill pill-asap" data-action="asap">Be there ASAP</button>
          ${deferBtn}
          <button class="pill pill-complete" data-action="complete">Complete</button>
        </div>
      </div>`;
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  function wireCard(card){
    card.querySelectorAll('.actions .pill').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const action = btn.dataset.action;
        const id = card.dataset.id;
        const room = card.dataset.room || null;
        const role = (card.dataset.role || 'nurse').toLowerCase();

        if(action==='defer'){
          socket.emit('defer_request', { id });
          // Optimistic role flip in UI
          card.classList.remove('role-cna'); card.classList.add('role-nurse');
          card.dataset.role = 'nurse';
          // If it didn’t actually change on the server we’ll be corrected by request_updated
          return;
        }

        if(action==='complete'){
          socket.emit('complete_request', {
            request_id: id,
            room_number: room,
            role: role
          });
          // Remove optimistically; server will also emit remove_request
          card.remove();
          if(!document.querySelector('.card')){
            listEl.insertAdjacentHTML('beforeend', `<div class="empty">No active requests.</div>`);
          }
          return;
        }

        // ack | omw | asap
        socket.emit('acknowledge_request', {
          room: 'dashboard',       // join/broadcast room (server supports this)
          request_id: id,
          room_number: room,
          status: action,          // 'ack' | 'omw' | 'asap'
          role: role
        });

        // Keep visual feedback (button stays slightly “pressed” feel)
        card.querySelectorAll('.actions .pill').forEach(b=>b.style.outline='');
        btn.style.outline = '3px solid rgba(17,24,39,.25)';
      });
    });
  }

  // Wire any server-rendered cards
  document.querySelectorAll('.card').forEach(wireCard);

  // --- Socket.IO live updates -----------------------------------------------
  const socket = io(); // default namespace
  socket.on('connect', ()=>{
    socket.emit('join', { room: 'dashboard' });
  });

  // New request arrives
  socket.on('new_request', (data)=>{
    // Remove "empty" placeholder if present
    const empty = document.querySelector('.empty');
    if(empty) empty.remove();

    // Prepend newest on top
    listEl.insertAdjacentHTML('afterbegin', cardHTML(data));
    wireCard(document.getElementById('req-'+data.id));
    updatedEl.textContent = 'Updated Just now';
  });

  // Request removed (completed)
  socket.on('remove_request', (data)=>{
    const id = data && (data.id || data.request_id);
    if(!id) return;
    const el = document.getElementById('req-'+id);
    if(el){ el.remove(); }
    if(!document.querySelector('.card')){
      listEl.insertAdjacentHTML('beforeend', `<div class="empty">No active requests.</div>`);
    }
    updatedEl.textContent = 'Updated Just now';
  });

  // Request updated (e.g., CNA → Nurse via “Defer”)
  socket.on('request_updated', (data)=>{
    const id = data && (data.id || data.request_id);
    if(!id) return;
    const el = document.getElementById('req-'+id);
    if(!el) return;
    if(data.new_role){
      const role = (data.new_role||'nurse').toLowerCase();
      el.dataset.role = role;
      el.classList.toggle('role-cna', role==='cna');
      el.classList.toggle('role-nurse', role!=='cna');
      // Add/remove Defer button based on new role
      const actions = el.querySelector('.actions');
      const hasDefer = !!actions.querySelector('[data-action="defer"]');
      if(role==='cna' && !hasDefer){
        const btn = document.createElement('button');
        btn.className = 'pill pill-defer';
        btn.dataset.action = 'defer';
        btn.textContent = 'Defer to Nurse';
        actions.insertBefore(btn, actions.querySelector('[data-action="complete"]'));
        wireCard(el); // rewire new button
      }else if(role!=='cna' && hasDefer){
        actions.querySelector('[data-action="defer"]').remove();
      }
    }
    if(data.new_timestamp){
      el.dataset.ts = data.new_timestamp;
      const ago = el.querySelector('.ago');
      if(ago) ago.textContent = timeAgo(data.new_timestamp);
    }
    updatedEl.textContent = 'Updated Just now';
  });
</script>
</body>
</html>
