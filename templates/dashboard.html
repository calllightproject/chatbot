<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real-Time Request Dashboard</title>
  <style>
    :root{
      --core-blue:#00205b;
      --link-blue:#062c8f;
      --pill-yellow:#fde68a;
      --pill-green:#b7f3c9;
      --pill-purple:#c7b8ff;
      --pill-cyan:#bfefff;
      --pill-gray:#c7ccd4;

      --card-nurse:#ffe9ec;   /* soft pink */
      --card-cna:#fff4de;     /* soft cream */
      --card-default:#f3fff5; /* minty green */
      --card-border:#e8eaf0;
      --text:#0b1728;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#f7f8fb;
      color:var(--text);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 22px;
    }
    .title{
      font-size:32px;
      font-weight:800;
      color:var(--core-blue);
      letter-spacing:.3px;
    }
    .top-actions{
      display:flex; gap:12px; align-items:center;
    }
    .btn{
      background:var(--core-blue);
      color:#fff; border:0; padding:10px 16px;
      border-radius:10px; font-weight:700; cursor:pointer;
    }
    .btn-link{
      background:var(--core-blue);
      color:#fff; text-decoration:none; padding:10px 16px;
      border-radius:10px; font-weight:700; display:inline-block;
    }
    .subtle{
      color:var(--muted); font-size:14px; margin-left:10px;
    }

    .wrap{padding:0 22px 32px}

    .card{
      border:1px solid var(--card-border);
      border-left:8px solid #36b37e;
      border-radius:16px;
      margin:16px 0;
      padding:22px;
      background:var(--card-default);
      box-shadow:0 1px 2px rgba(0,0,0,.03);
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .card.role-nurse{ background:var(--card-nurse); border-left-color:#f43f5e; }
    .card.role-cna{   background:var(--card-cna);   border-left-color:#ff9f1a; }

    .left{
      min-width:0; /* wrap nicely */
    }
    .req-text{
      font-size:28px; font-weight:800; margin:0 0 8px 0;
      color:#0c1222;
    }
    .meta{
      display:flex; gap:22px; flex-wrap:wrap; align-items:center; color:var(--muted);
      font-size:16px;
    }
    .meta b{ color:#1f2937; }
    .status-pill{
      display:inline-block; padding:6px 12px; border-radius:999px;
      background:#eef2ff; color:#3730a3; font-weight:700; font-size:16px;
      margin-left:8px;
    }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; }
    .pill-btn{
      border:0; border-radius:999px; padding:12px 18px; font-weight:800; cursor:pointer;
      font-size:18px;
    }
    .ack{ background:var(--pill-yellow); }
    .omw{ background:var(--pill-green); }
    .asap{ background:var(--pill-purple); }
    .defer{ background:var(--pill-cyan); }
    .complete{ background:var(--pill-gray); }

    /* tiny chips under buttons (optional nurse/room chips like your older screen) */
    .chips{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      font-size:12px; color:#274060; background:#e8eefc; padding:6px 10px; border-radius:999px;
      border:1px solid #d7e2ff;
    }

    /* empty state */
    .empty{
      text-align:center; color:var(--muted); margin:36px 0 18px;
      font-size:18px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Real-Time Request Dashboard</div>
    <div class="top-actions">
      <button id="refreshBtn" class="btn">Refresh</button>
      <span id="updatedAt" class="subtle">Updated —</span>
      <a class="btn-link" href="{{ url_for('staff_portal') }}">View My Rooms</a>
      <a class="btn-link" href="{{ url_for('analytics') }}">View Analytics</a>
    </div>
  </div>

  <div class="wrap">
    <div id="cards"></div>
    <div id="empty" class="empty" style="display:none">No active requests.</div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // ----- Utilities -----
    function nowStamp(){
      const d=new Date();
      const p=n=>String(n).padStart(2,'0');
      return `${(d.getHours()%12)||12}:${p(d.getMinutes())}:${p(d.getSeconds())} ${d.getHours()<12?'AM':'PM'}`;
    }
    function timeAgo(iso){
      if(!iso) return '';
      const t=new Date(iso).getTime();
      const s=Math.max(0,Math.floor((Date.now()-t)/1000));
      if(s<60) return 'Just now';
      const m=Math.floor(s/60); if(m<60) return `${m}m ago`;
      const h=Math.floor(m/60); if(h<24) return `${h}h ago`;
      const d=Math.floor(h/24); return `${d}d ago`;
    }
    function roleClass(role){
      const r=(role||'').toLowerCase();
      if(r==='nurse') return 'role-nurse';
      if(r==='cna')   return 'role-cna';
      return '';
    }
    function statusLabel(st){
      if(!st) return '';
      const s=st.toLowerCase();
      if(s==='ack') return 'Acknowledged';
      if(s==='omw') return 'On my way';
      if(s==='asap')return 'Be there ASAP';
      return '';
    }

    // ----- DOM -----
    const cardsEl = document.getElementById('cards');
    const emptyEl = document.getElementById('empty');
    const updatedEl = document.getElementById('updatedAt');

    const state = {
      items: new Map(),       // id -> item {id,room,request,role,timestamp}
      status: new Map(),      // id -> 'ack'|'omw'|'asap'
    };

    function setUpdated(){
      updatedEl.textContent = `Updated ${nowStamp()}`;
    }

    function ensureEmpty(){
      emptyEl.style.display = state.items.size ? 'none' : 'block';
    }

    function cardHTML(item){
      const st = state.status.get(item.id) || '';
      const stText = statusLabel(st);
      return `
        <div class="card ${roleClass(item.role)}" id="req-${item.id}">
          <div class="left">
            <h3 class="req-text">${escapeHtml(item.request || '—')}</h3>
            <div class="meta">
              <span>Room: <b>${escapeHtml(item.room || '—')}</b></span>
              <span>For: <b>${String(item.role||'').toUpperCase()}</b></span>
              <span>${timeAgo(item.timestamp)}</span>
              ${stText ? `<span class="status-pill">${stText}</span>` : ``}
            </div>
          </div>

          <div class="right">
            <div class="actions">
              <button class="pill-btn ack" onclick="sendStatus('${item.id}','${item.room}','${item.role}','ack')">Acknowledge</button>
              <button class="pill-btn omw" onclick="sendStatus('${item.id}','${item.room}','${item.role}','omw')">On my way</button>
              <button class="pill-btn asap" onclick="sendStatus('${item.id}','${item.room}','${item.role}','asap')">Be there ASAP</button>
              <button class="pill-btn defer" onclick="deferToNurse('${item.id}')">Defer to Nurse</button>
              <button class="pill-btn complete" onclick="completeReq('${item.id}','${item.room}','${item.role}')">Complete</button>
            </div>
            <div class="chips">
              <span class="chip">${String(item.role||'').toUpperCase()}</span>
              <span class="chip">Room ${escapeHtml(item.room || '—')}</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderAll(){
      const parts=[];
      state.items.forEach(it=>parts.push(cardHTML(it)));
      cardsEl.innerHTML = parts.join('');
      ensureEmpty();
      setUpdated();
    }

    function upsert(item){
      // normalize
      const norm = {
        id: item.id || item.request_id || String(Date.now()),
        room: item.room || '',
        request: item.request || item.user_input || '',
        role: (item.role || item.category || 'nurse'),
        timestamp: item.timestamp || new Date().toISOString(),
      };
      state.items.set(norm.id, norm);
      // keep any existing status pill
      if(!state.status.has(norm.id) && item.status){
        state.status.set(norm.id, item.status);
      }
      // re-render single card
      const el = document.getElementById(`req-${norm.id}`);
      if(el){
        el.outerHTML = cardHTML(norm);
      }else{
        const div=document.createElement('div');
        div.innerHTML=cardHTML(norm);
        cardsEl.prepend(div.firstElementChild);
      }
      ensureEmpty();
      setUpdated();
    }

    function removeById(id){
      state.items.delete(id);
      state.status.delete(id);
      const el=document.getElementById(`req-${id}`);
      if(el) el.remove();
      ensureEmpty();
      setUpdated();
    }

    function updateRole(id, newRole){
      const item = state.items.get(id);
      if(!item) return;
      item.role = newRole || item.role;
      upsert(item);
    }

    // escape helper for HTML
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    // ----- Socket.IO (DEFAULT namespace) -----
    const socket = io(); // IMPORTANT: default namespace for dashboard

    // stream new items live
    socket.on('new_request', (data) => {
      upsert(data);
    });

    socket.on('remove_request', (data) => {
      if(data && data.id) removeById(data.id);
    });

    socket.on('request_updated', (data) => {
      // used for "defer to nurse"
      if(data && data.id){
        if (data.new_role) updateRole(data.id, data.new_role);
        setUpdated();
      }
    });

    // ----- Actions -----
    function sendStatus(id, room, role, status){
      // keep the pill on the card immediately
      state.status.set(id, status);
      const item = state.items.get(id);
      if(item){ upsert(item); } // re-render card with pill

      socket.emit('acknowledge_request', {
        request_id: id,
        room: 'manager_dashboard',   // legacy broadcast room (safe)
        message: status === 'ack' ? 'Acknowledged'
                : status === 'omw' ? 'On my way'
                : 'Be there ASAP',
        status: status,
        room_number: room,
        role: (role||'nurse')
      });
    }

    function deferToNurse(id){
      socket.emit('defer_request', { id });
    }

    function completeReq(id, room, role){
      socket.emit('complete_request', {
        request_id: id,
        room_number: room,
        role: (role||'nurse')
      });
    }

    // ----- Initial load + manual refresh -----
    const initial = {{ active_requests|tojson|safe }};
    (initial || []).forEach(upsert);
    ensureEmpty();
    setUpdated();

    document.getElementById('refreshBtn').addEventListener('click', async () => {
      try{
        const r = await fetch('{{ url_for("api_active_requests") }}');
        const j = await r.json();
        state.items.clear();
        state.status.clear();
        (j.active_requests||[]).forEach(upsert);
      }catch(e){
        console.error(e);
      }finally{
        setUpdated();
      }
    });

    // keep “time ago” text fresh every minute
    setInterval(() => {
      state.items.forEach(it => upsert(it));
    }, 60_000);
  </script>
</body>
</html>
